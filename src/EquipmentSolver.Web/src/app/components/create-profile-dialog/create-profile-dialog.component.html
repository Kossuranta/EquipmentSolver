<h2 mat-dialog-title>Create Game Profile</h2>

<mat-dialog-content>
  @if (error()) {
    <p class="error-message">{{ error() }}</p>
  }

  <form [formGroup]="form">
    <mat-form-field class="full-width">
      <mat-label>Profile Name</mat-label>
      <input matInput formControlName="name" placeholder="e.g., PvP Build, Max Magic Resist" />
      @if (form.get('name')?.hasError('required') && form.get('name')?.touched) {
        <mat-error>Profile name is required</mat-error>
      } @else if (form.get('name')?.hasError('maxlength')) {
        <mat-error>Profile name must be at most 100 characters</mat-error>
      }
      <mat-hint align="end">{{ form.value.name?.length ?? 0 }}/100</mat-hint>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Game</mat-label>
      <input
        matInput
        [formControl]="gameSearchControl"
        [matAutocomplete]="auto"
        placeholder="Search for a game..."
      />
      <mat-autocomplete
        #auto="matAutocomplete"
        [displayWith]="displayGame"
        (optionSelected)="selectGame($event.option.value)"
      >
        @for (game of gameResults(); track game.igdbId) {
          <mat-option [value]="game">
            <div class="game-option">
              @if (game.coverUrl) {
                <img [src]="game.coverUrl" [alt]="game.name" class="game-option-cover" />
              }
              <span>{{ game.name }}</span>
            </div>
          </mat-option>
        }
      </mat-autocomplete>
      @if (searching()) {
        <mat-spinner matSuffix diameter="20"></mat-spinner>
      }
      <mat-hint>Search IGDB for your game.</mat-hint>
    </mat-form-field>

    @if (selectedGame()) {
      <div class="selected-game-preview">
        @if (selectedGame()!.coverUrl) {
          <img [src]="selectedGame()!.coverUrl" [alt]="selectedGame()!.name" class="selected-cover" />
        }
        <span class="selected-name">{{ selectedGame()!.name }}</span>
        <mat-icon class="check-icon">check_circle</mat-icon>
      </div>
    }

    <mat-form-field class="full-width">
      <mat-label>Description (optional)</mat-label>
      <textarea
        matInput
        formControlName="description"
        rows="3"
        placeholder="e.g., Optimized for late-game PvP..."
      ></textarea>
      <mat-hint align="end">{{ form.value.description?.length ?? 0 }}/500</mat-hint>
    </mat-form-field>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="saving()">Cancel</button>
  <button
    mat-flat-button
    (click)="save()"
    [disabled]="saving() || !selectedGame() || form.invalid"
  >
    @if (saving()) {
      <mat-spinner diameter="20"></mat-spinner>
    } @else {
      Create
    }
  </button>
</mat-dialog-actions>
