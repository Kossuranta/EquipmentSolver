@if (error()) {
  <p class="error-message">{{ error() }}</p>
}

@if (isOwner) {
  <div class="add-row">
    <button mat-flat-button (click)="openAddDialog()" [disabled]="slots.length === 0">
      <mat-icon>add</mat-icon>
      Add Equipment
    </button>
    <button mat-stroked-button [matMenuTriggerFor]="csvMenu">
      <mat-icon>swap_vert</mat-icon>
      CSV
    </button>
    <mat-menu #csvMenu="matMenu">
      <button mat-menu-item (click)="importCsv()">
        <mat-icon>upload</mat-icon>
        <span>Import CSV</span>
      </button>
      <button mat-menu-item (click)="exportCsv()" [disabled]="equipment.length === 0">
        <mat-icon>download</mat-icon>
        <span>Export CSV</span>
      </button>
      <button mat-menu-item (click)="downloadTemplate()">
        <mat-icon>description</mat-icon>
        <span>Download Template</span>
      </button>
    </mat-menu>
    @if (slots.length === 0) {
      <span class="hint">Add slots first before creating equipment.</span>
    }
  </div>
}

@if (equipment.length === 0) {
  <p class="empty-hint">No equipment added yet.</p>
} @else {
  <mat-accordion multi>
    @for (item of equipment; track item.id) {
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>{{ item.name }}</mat-panel-title>
          <mat-panel-description>
            <span class="slot-list" [matTooltip]="getAllSlotNames(item)" [matTooltipDisabled]="item.compatibleSlotIds.length <= 2">
              {{ getSlotSummary(item) }}
            </span>
            &middot; {{ item.stats.length }} stat(s)
          </mat-panel-description>
          @if (isOwner) {
            <div class="header-actions" (click)="$event.stopPropagation()">
              <button mat-icon-button (click)="openEditDialog(item)" matTooltip="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="duplicateEquipment(item)" matTooltip="Duplicate">
                <mat-icon>content_copy</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteEquipment(item)" matTooltip="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
        </mat-expansion-panel-header>

        <div class="equipment-detail">
          <div class="detail-section">
            <h4>Compatible Slots</h4>
            <mat-chip-set>
              @for (slotId of item.compatibleSlotIds; track slotId) {
                <mat-chip>{{ getSlotName(slotId) }}</mat-chip>
              }
            </mat-chip-set>
          </div>

          @if (item.stats.length > 0) {
            <div class="detail-section">
              <h4>Stats</h4>
              <div class="stats-list">
                @for (stat of item.stats; track stat.statTypeId) {
                  <div class="stat-row">
                    <span class="stat-name">{{ getStatDisplay(stat) }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </mat-expansion-panel>
    }
  </mat-accordion>
}
